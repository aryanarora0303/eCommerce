#!/bin/bash

echo "ğŸš€ eCommerce API - Postman Collection Generator"
echo "=============================================="

# Configuration
API_URL="http://localhost:3151"
HEALTH_ENDPOINT="/health"
OPENAPI_ENDPOINT="/api-json"
POSTMAN_DIR="postman"
COLLECTION_FILE="generated-postman-collection.json"
ENVIRONMENT_FILE="postman-environment.json"

# Create postman directory if it doesn't exist
if [ ! -d "$POSTMAN_DIR" ]; then
    echo "ğŸ“ Creating postman directory..."
    mkdir -p "$POSTMAN_DIR"
    echo "âœ… Directory created: $POSTMAN_DIR/"
fi

# Check if API is running
echo "ğŸ“¡ Checking if API is running at $API_URL..."
if ! curl -sf "$API_URL$HEALTH_ENDPOINT" > /dev/null; then
    echo "âŒ Error: API is not running at $API_URL"
    echo "   Please start the API server with: npm run start:dev"
    exit 1
fi

echo "âœ… API is running successfully!"

# Download OpenAPI specification
echo "ğŸ“¥ Downloading OpenAPI specification..."
if ! curl -sf "$API_URL$OPENAPI_ENDPOINT" -o "$POSTMAN_DIR/postman-collection-openapi.json"; then
    echo "âŒ Error: Could not download OpenAPI specification"
    echo "   Make sure the API is running and OpenAPI documentation is available"
    exit 1
fi

echo "âœ… OpenAPI specification downloaded!"

echo ""
echo "ğŸ“‹ Available Postman Collections:"
echo "================================="
echo "1. ğŸ“ $POSTMAN_DIR/postman-collection-openapi.json - Traditional OpenAPI-generated collection (no tests)"
echo "2. ğŸ“ $POSTMAN_DIR/postman-collection.json - Complete API test suite (32 requests, ~100+ tests)"
echo "3. ğŸ“ $POSTMAN_DIR/postman-collection-practice.json - Practice test suite (empty tests for learning)"
echo "4. ğŸ“ $POSTMAN_DIR/postman-environment.json - Environment variables and test data"
echo ""

# Run the collections if requested
echo "ğŸ”§ Usage Options:"
echo "================"
echo ""
echo "Option 1: Import into Postman GUI"
echo "  ğŸ“‹ For basic API exploration (no tests):"
echo "    â€¢ Import '$POSTMAN_DIR/postman-collection-openapi.json' directly"
echo "    â€¢ Import '$POSTMAN_DIR/postman-environment.json' for variables"
echo ""
echo "  ğŸ§ª For comprehensive testing:"
echo "    â€¢ Import '$POSTMAN_DIR/postman-collection.json' and '$POSTMAN_DIR/postman-environment.json'"
echo "    â€¢ Use Collection Runner to execute all tests"
echo ""
echo "  ğŸ“š For learning/practice:"
echo "    â€¢ Import '$POSTMAN_DIR/postman-collection-practice.json' and '$POSTMAN_DIR/postman-environment.json'"
echo "    â€¢ Fill in TODO sections to learn API testing"
echo ""
echo "Option 2: Run with Newman CLI"
echo "  ğŸƒâ€â™‚ï¸ For automated testing in CI/CD: Not in scope"
echo ""

# Offer to run tests
echo "ğŸš€ Collection Import Instructions:"
echo "=================================="
echo ""
echo "ğŸ“‹ To import the traditional OpenAPI collection (basic endpoints):"
echo "   1. Open Postman"
echo "   2. Click 'Import' â†’ 'Upload Files'"
echo "   3. Navigate to '$POSTMAN_DIR/' folder"
echo "   4. Select 'openapi-spec.json'"
echo "   5. Also import 'postman-environment.json' for environment variables"
echo "   6. This gives you all endpoints for manual testing"
echo ""
echo "ğŸ§ª To import the comprehensive test collection:"
echo "   1. Import both '$POSTMAN_DIR/postman-collection.json' and '$POSTMAN_DIR/postman-environment.json'"
echo "   2. Use Collection Runner to execute automated tests"
echo ""
echo "ğŸ“š To import the practice collection for learning:"
echo "   1. Import both '$POSTMAN_DIR/postman-collection-practice.json' and '$POSTMAN_DIR/postman-environment.json'"
echo "   2. Fill in TODO sections in test scripts to learn API testing"
echo ""
echo "ğŸ”— Direct OpenAPI import (alternative):"
echo "   â€¢ In Postman: Import â†’ Link â†’ http://localhost:3151/api-json"
echo ""

echo ""
echo "ğŸ“Š Test Coverage Summary:"
echo "========================="
echo "â€¢ Authentication & Security: âœ… JWT, login/logout, role-based access"
echo "â€¢ User Management: âœ… CRUD operations, search, validation"  
echo "â€¢ Product Management: âœ… Admin operations, public access, filtering"
echo "â€¢ Order Processing: âœ… Creation, status updates, history"
echo "â€¢ Review System: âœ… CRUD operations, product association"
echo "â€¢ Authorization: âœ… Role-based permissions, security testing"
echo "â€¢ Error Handling: âœ… Validation, 404s, unauthorized access"
echo "â€¢ Health Checks: âœ… API availability, performance"
echo "â€¢ E2E Workflows: âœ… Complete customer journeys, edge cases"
echo ""
echo "ğŸ“ Generated Files:"
echo "=================="
echo "â€¢ $POSTMAN_DIR/postman-collection-openapi.json - OpenAPI specification & traditional Postman collection"
echo "â€¢ $POSTMAN_DIR/postman-collection.json - Comprehensive test collection"
echo "â€¢ $POSTMAN_DIR/postman-collection-practice.json - Practice test collection with TODO sections"
echo "â€¢ $POSTMAN_DIR/postman-environment.json - Environment variables"
echo "â€¢ $POSTMAN_DIR/test-report.html - Test execution report (if tests ran)"
echo ""
echo "ğŸ¯ Next Steps:"
echo "=============="
echo "1. Import $POSTMAN_DIR/postman-collection-openapi.json for basic API exploration"
echo "2. Import $POSTMAN_DIR/postman-collection.json for comprehensive testing"
echo "3. Import $POSTMAN_DIR/postman-collection-practice.json for learning API testing"
echo ""
echo "ğŸ’¡ Collection Types Explained:"
echo "============================="
echo "ğŸ”§ $POSTMAN_DIR/postman-collection-openapi.json:"
echo "   â€¢ Basic endpoints without test scripts"
echo "   â€¢ Good for API exploration and manual testing"
echo "   â€¢ Generated directly from OpenAPI specification"
echo ""
echo "ğŸ§ª $POSTMAN_DIR/postman-collection.json:"
echo "   â€¢ Comprehensive test suite with assertions"
echo "   â€¢ Automated validation of responses"
echo "   â€¢ Equivalent to your Jest integration tests"
echo ""
echo "ğŸ“š $POSTMAN_DIR/postman-collection-practice.json:"
echo "   â€¢ Learning-oriented version with TODO sections"
echo "   â€¢ Same structure as complete collection but empty tests"
echo "   â€¢ Perfect for hands-on API testing education"
echo ""
echo "ğŸ—„ï¸  Database Management Commands:"
echo "=================================="
echo "â€¢ npm run db:seed       - Populate database with sample data"
echo "â€¢ npm run db:truncate   - Delete all data from database"
echo "â€¢ npm test              - Run test suite (requires clean/seeded DB)"
echo ""
echo "âœ¨ Happy Testing!"
